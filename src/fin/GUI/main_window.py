import sys
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QListWidget, QListWidgetItem, QLabel, QLineEdit,
    QDialog, QFormLayout, QMessageBox, QFrame, QScrollArea,
    QGridLayout, QDateEdit, QComboBox, QSpinBox, QDoubleSpinBox, QSizePolicy
)
from PySide6.QtCore import Qt, QDate
from PySide6.QtGui import QFont, QPalette, QColor
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º –ë–î
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'db'))
from database import add_category, del_category, get_all_category, get_category
from DB_payment import add_payment, del_payment, get_payment_by_category, get_total_statistics, get_statistics_by_date_range, get_category_statistics

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
try:
    from .advanced_features import SearchDialog, ExportDialog, BudgetDialog, ReportsDialog
except ImportError:
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏
    class SearchDialog(QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("–ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π")
            self.setModal(True)
            self.setFixedSize(400, 200)
            
            layout = QVBoxLayout()
            info_label = QLabel("üîç –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π")
            info_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            info_label.setStyleSheet("font-size: 16px; color: #666; padding: 20px;")
            
            desc_label = QLabel("–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
            desc_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            desc_label.setStyleSheet("color: #999; padding: 10px;")
            
            ok_button = QPushButton("OK")
            ok_button.clicked.connect(self.accept)
            
            layout.addWidget(info_label)
            layout.addWidget(desc_label)
            layout.addWidget(ok_button)
            
            self.setLayout(layout)
    
    class ExportDialog(QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö")
            self.setModal(True)
            self.setFixedSize(400, 200)
            
            layout = QVBoxLayout()
            info_label = QLabel("üì§ –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö")
            info_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            info_label.setStyleSheet("font-size: 16px; color: #666; padding: 20px;")
            
            desc_label = QLabel("–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
            desc_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            desc_label.setStyleSheet("color: #999; padding: 10px;")
            
            ok_button = QPushButton("OK")
            ok_button.clicked.connect(self.accept)
            
            layout.addWidget(info_label)
            layout.addWidget(desc_label)
            layout.addWidget(ok_button)
            
            self.setLayout(layout)
    
    class BudgetDialog(QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–æ–º")
            self.setModal(True)
            self.setFixedSize(400, 200)
            
            layout = QVBoxLayout()
            info_label = QLabel("üí∞ –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–æ–º")
            info_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            info_label.setStyleSheet("font-size: 16px; color: #666; padding: 20px;")
            
            desc_label = QLabel("–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
            desc_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            desc_label.setStyleSheet("color: #999; padding: 10px;")
            
            ok_button = QPushButton("OK")
            ok_button.clicked.connect(self.accept)
            
            layout.addWidget(info_label)
            layout.addWidget(desc_label)
            layout.addWidget(ok_button)
            
            self.setLayout(layout)
    
    class ReportsDialog(QDialog):
        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle("–û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞")
            self.setModal(True)
            self.setFixedSize(400, 200)
            
            layout = QVBoxLayout()
            info_label = QLabel("üìä –§—É–Ω–∫—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏")
            info_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            info_label.setStyleSheet("font-size: 16px; color: #666; padding: 20px;")
            
            desc_label = QLabel("–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
            desc_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            desc_label.setStyleSheet("color: #999; padding: 10px;")
            
            ok_button = QPushButton("OK")
            ok_button.clicked.connect(self.accept)
            
            layout.addWidget(info_label)
            layout.addWidget(desc_label)
            layout.addWidget(ok_button)
            
            self.setLayout(layout)


class CategoryDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é")
        self.setModal(True)
        self.setFixedSize(350, 180)
        
        layout = QVBoxLayout()
        
        # –§–æ—Ä–º–∞
        form_layout = QFormLayout()
        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
        self.name_edit.setMinimumHeight(35)
        self.name_edit.setStyleSheet("""
            QLineEdit {
                padding: 8px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 5px;
                background: white;
                color: #333;
            }
            QLineEdit:focus {
                border-color: #007bff;
            }
        """)
        form_layout.addRow("–ù–∞–∑–≤–∞–Ω–∏–µ:", self.name_edit)
        
        layout.addLayout(form_layout)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        self.ok_button = QPushButton("–î–æ–±–∞–≤–∏—Ç—å")
        self.cancel_button = QPushButton("–û—Ç–º–µ–Ω–∞")
        
        self.ok_button.clicked.connect(self.accept)
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.ok_button)
        button_layout.addWidget(self.cancel_button)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)


class PaymentDialog(QDialog):
    """–î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    
    def __init__(self, category_id, parent=None):
        super().__init__(parent)
        self.category_id = category_id
        self.setWindowTitle("–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂")
        self.setModal(True)
        self.setFixedSize(450, 350)
        
        layout = QVBoxLayout()
        
        # –§–æ—Ä–º–∞
        form_layout = QFormLayout()
        
        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞")
        self.name_edit.setMinimumHeight(35)
        self.name_edit.setStyleSheet("""
            QLineEdit {
                padding: 8px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 5px;
                background: white;
                color: #333;
            }
            QLineEdit:focus {
                border-color: #007bff;
            }
        """)
        form_layout.addRow("–ù–∞–∑–≤–∞–Ω–∏–µ:", self.name_edit)
        
        self.date_edit = QDateEdit()
        self.date_edit.setDate(QDate.currentDate())
        self.date_edit.setCalendarPopup(True)
        self.date_edit.setMinimumHeight(35)
        self.date_edit.setStyleSheet("""
            QDateEdit {
                padding: 8px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 5px;
                background: white;
                color: #333;
            }
            QDateEdit:focus {
                border-color: #007bff;
            }
        """)
        form_layout.addRow("–î–∞—Ç–∞:", self.date_edit)
        
        self.amount_edit = QDoubleSpinBox()
        self.amount_edit.setRange(0, 999999.99)
        self.amount_edit.setDecimals(2)
        self.amount_edit.setSuffix(" ‚ÇΩ")
        self.amount_edit.setMinimumHeight(35)
        self.amount_edit.setStyleSheet("""
            QDoubleSpinBox {
                padding: 8px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 5px;
                background: white;
                color: #333;
            }
            QDoubleSpinBox:focus {
                border-color: #007bff;
            }
        """)
        form_layout.addRow("–°—É–º–º–∞:", self.amount_edit)
        
        self.type_combo = QComboBox()
        self.type_combo.addItems(["expense", "income"])
        self.type_combo.setMinimumHeight(35)
        self.type_combo.setStyleSheet("""
            QComboBox {
                padding: 8px;
                font-size: 14px;
                border: 2px solid #ddd;
                border-radius: 5px;
                background: white;
                color: #333;
            }
            QComboBox:focus {
                border-color: #007bff;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
        """)
        form_layout.addRow("–¢–∏–ø:", self.type_combo)
        
        layout.addLayout(form_layout)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        self.ok_button = QPushButton("–î–æ–±–∞–≤–∏—Ç—å")
        self.cancel_button = QPushButton("–û—Ç–º–µ–Ω–∞")
        
        self.ok_button.clicked.connect(self.accept)
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.ok_button)
        button_layout.addWidget(self.cancel_button)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)


class PaymentWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞"""
    
    def __init__(self, payment_data, parent=None):
        super().__init__(parent)
        self.payment_data = payment_data
        self.parent_widget = parent
        self.setup_ui()
    
    def setup_ui(self):
        layout = QHBoxLayout()
        layout.setContentsMargins(15, 10, 15, 10)
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_layout = QVBoxLayout()
        
        name_label = QLabel(self.payment_data[1])  # name (—Ç–µ–ø–µ—Ä—å –∏–Ω–¥–µ–∫—Å 1)
        name_label.setFont(QFont("Arial", 12, QFont.Weight.Bold))
        name_label.setStyleSheet("color: #2c3e50;")
        
        date_label = QLabel(f"–î–∞—Ç–∞: {self.payment_data[2]}")  # date (—Ç–µ–ø–µ—Ä—å –∏–Ω–¥–µ–∫—Å 2)
        date_label.setStyleSheet("color: #666; font-size: 11px;")
        
        info_layout.addWidget(name_label)
        info_layout.addWidget(date_label)
        
        layout.addLayout(info_layout)
        layout.addStretch()
        
        # –°—É–º–º–∞ –∏ —Ç–∏–ø
        amount_layout = QVBoxLayout()
        
        amount = self.payment_data[3]  # amount (—Ç–µ–ø–µ—Ä—å –∏–Ω–¥–µ–∫—Å 3)
        payment_type = self.payment_data[4]  # type (—Ç–µ–ø–µ—Ä—å –∏–Ω–¥–µ–∫—Å 4)
        
        amount_label = QLabel(f"{amount:.2f} ‚ÇΩ")
        amount_label.setFont(QFont("Arial", 14, QFont.Weight.Bold))
        
        if payment_type == "income":
            amount_label.setStyleSheet("color: #28a745;")
            type_label = QLabel("–î–æ—Ö–æ–¥")
            type_label.setStyleSheet("color: #28a745; background: #d4edda; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;")
        else:
            amount_label.setStyleSheet("color: #dc3545;")
            type_label = QLabel("–†–∞—Å—Ö–æ–¥")
            type_label.setStyleSheet("color: #dc3545; background: #f8d7da; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;")
        
        amount_layout.addWidget(amount_label)
        amount_layout.addWidget(type_label)
        
        layout.addLayout(amount_layout)
        
        # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        delete_button = QPushButton("üóë")
        delete_button.setFixedSize(30, 30)
        delete_button.setStyleSheet("""
            QPushButton {
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 15px;
                font-size: 12px;
            }
            QPushButton:hover {
                background: #c82333;
            }
        """)
        delete_button.clicked.connect(self.delete_payment)
        
        layout.addWidget(delete_button)
        
        self.setLayout(layout)
        
        # –°—Ç–∏–ª–∏
        self.setStyleSheet("""
            QWidget {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                margin: 3px;
                padding: 5px;
            }
            QWidget:hover {
                border: 1px solid #007bff;
                background: #f8f9fa;
            }
        """)
    
    def delete_payment(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞"""
        payment_id = self.payment_data[0]  # ID –ø–ª–∞—Ç–µ–∂–∞
        payment_name = self.payment_data[1]  # –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        
        # –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        confirm_dialog = QDialog(self)
        confirm_dialog.setWindowTitle("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è")
        confirm_dialog.setModal(True)
        confirm_dialog.setFixedSize(400, 150)
        confirm_dialog.setStyleSheet("""
            QDialog {
                background: white;
            }
            QLabel {
                color: #333;
                font-size: 14px;
            }
            QPushButton {
                padding: 10px 20px;
                font-size: 14px;
                border-radius: 5px;
                border: none;
                min-width: 80px;
            }
            QPushButton#delete {
                background: #dc3545;
                color: white;
            }
            QPushButton#delete:hover {
                background: #c82333;
            }
            QPushButton#cancel {
                background: #6c757d;
                color: white;
            }
            QPushButton#cancel:hover {
                background: #5a6268;
            }
        """)
        
        layout = QVBoxLayout(confirm_dialog)
        
        # –¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        message_label = QLabel(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂:")
        message_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        payment_label = QLabel(f"¬´{payment_name}¬ª")
        payment_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        payment_label.setStyleSheet("font-weight: bold; color: #dc3545; font-size: 16px;")
        
        layout.addWidget(message_label)
        layout.addWidget(payment_label)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        button_layout.addStretch()
        
        cancel_button = QPushButton("–û—Ç–º–µ–Ω–∞")
        cancel_button.setObjectName("cancel")
        cancel_button.clicked.connect(confirm_dialog.reject)
        
        delete_button = QPushButton("–£–¥–∞–ª–∏—Ç—å")
        delete_button.setObjectName("delete")
        delete_button.clicked.connect(confirm_dialog.accept)
        
        button_layout.addWidget(cancel_button)
        button_layout.addWidget(delete_button)
        
        layout.addLayout(button_layout)
        
        if confirm_dialog.exec() == QDialog.DialogCode.Accepted:
            del_payment(payment_id)
            if hasattr(self.parent_widget, 'load_payments'):
                self.parent_widget.load_payments()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            main_window = self.parent_widget.parent()
            if hasattr(main_window, 'update_statistics'):
                main_window.update_statistics()


class CategoryViewWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    
    def __init__(self, category_id, category_name, parent=None):
        super().__init__(parent)
        self.category_id = category_id
        self.category_name = category_name
        self.setup_ui()
        self.load_payments()
    
    def setup_ui(self):
        layout = QVBoxLayout()
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header_layout = QHBoxLayout()
        
        title_label = QLabel(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {self.category_name}")
        title_label.setFont(QFont("Arial", 16, QFont.Weight.Bold))
        
        back_button = QPushButton("‚Üê –ù–∞–∑–∞–¥")
        back_button.clicked.connect(self.go_back)
        
        add_payment_button = QPushButton("+ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂")
        add_payment_button.clicked.connect(self.add_payment)
        
        header_layout.addWidget(back_button)
        header_layout.addStretch()
        header_layout.addWidget(title_label)
        header_layout.addStretch()
        header_layout.addWidget(add_payment_button)
        
        layout.addLayout(header_layout)
        
        # –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π
        self.payments_list = QListWidget()
        self.payments_list.setSpacing(5)
        layout.addWidget(self.payments_list)
        
        self.setLayout(layout)
    
    def load_payments(self):
        self.payments_list.clear()
        payments = get_payment_by_category(self.category_id)
        
        if not payments:
            no_payments_label = QLabel("–ü–ª–∞—Ç–µ–∂–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç")
            no_payments_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            no_payments_label.setStyleSheet("color: #666; padding: 20px; font-size: 14px;")
            self.payments_list.addItem("")
            self.payments_list.setItemWidget(self.payments_list.item(0), no_payments_label)
        else:
            total_income = 0
            total_expense = 0
            
            for payment in payments:
                payment_widget = PaymentWidget(payment, self)
                item = QListWidgetItem()
                item.setSizeHint(payment_widget.sizeHint())
                self.payments_list.addItem(item)
                self.payments_list.setItemWidget(item, payment_widget)
                
                # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–µ —Å—É–º–º—ã
                amount = payment[3]  # amount
                payment_type = payment[4]  # type
                if payment_type == "income":
                    total_income += amount
                else:
                    total_expense += amount
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º–∞—Ä–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–Ω–∏–∑—É
            self.add_summary_widget(total_income, total_expense)
    
    def add_summary_widget(self, total_income, total_expense):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –≤–∏–¥–∂–µ—Ç —Å —Å—É–º–º–∞—Ä–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
        summary_widget = QWidget()
        summary_widget.setStyleSheet("""
            QWidget {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                margin: 10px;
                padding: 15px;
            }
        """)
        
        summary_layout = QHBoxLayout(summary_widget)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = QLabel("–ò—Ç–æ–≥–æ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:")
        title_label.setFont(QFont("Arial", 12, QFont.Weight.Bold))
        title_label.setStyleSheet("color: #495057;")
        
        summary_layout.addWidget(title_label)
        summary_layout.addStretch()
        
        # –î–æ—Ö–æ–¥—ã
        if total_income > 0:
            income_label = QLabel(f"–î–æ—Ö–æ–¥—ã: +{total_income:.2f} ‚ÇΩ")
            income_label.setStyleSheet("color: #28a745; font-weight: bold; font-size: 14px; margin-right: 20px;")
            summary_layout.addWidget(income_label)
        
        # –†–∞—Å—Ö–æ–¥—ã
        if total_expense > 0:
            expense_label = QLabel(f"–†–∞—Å—Ö–æ–¥—ã: -{total_expense:.2f} ‚ÇΩ")
            expense_label.setStyleSheet("color: #dc3545; font-weight: bold; font-size: 14px;")
            summary_layout.addWidget(expense_label)
        
        # –ë–∞–ª–∞–Ω—Å
        balance = total_income - total_expense
        if balance != 0:
            balance_color = "#28a745" if balance > 0 else "#dc3545"
            balance_sign = "+" if balance > 0 else ""
            balance_label = QLabel(f"–ë–∞–ª–∞–Ω—Å: {balance_sign}{balance:.2f} ‚ÇΩ")
            balance_label.setStyleSheet(f"color: {balance_color}; font-weight: bold; font-size: 14px; margin-left: 20px;")
            summary_layout.addWidget(balance_label)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
        item = QListWidgetItem()
        item.setSizeHint(summary_widget.sizeHint())
        self.payments_list.addItem(item)
        self.payments_list.setItemWidget(item, summary_widget)
    
    def add_payment(self):
        dialog = PaymentDialog(self.category_id, self)
        if dialog.exec() == QDialog.DialogCode.Accepted:
            name = dialog.name_edit.text()
            date = dialog.date_edit.date().toString("yyyy-MM-dd")
            amount = dialog.amount_edit.value()
            payment_type = dialog.type_combo.currentText()
            
            add_payment(name, date, amount, payment_type, self.category_id)
            self.load_payments()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if hasattr(self.parent(), 'update_statistics'):
                self.parent().update_statistics()
    
    def go_back(self):
        """–í–æ–∑–≤—Ä–∞—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –≤–∏–¥—É"""
        # –ò—â–µ–º –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
        parent = self.parent()
        while parent and not hasattr(parent, 'show_main_view'):
            parent = parent.parent()
        
        if parent and hasattr(parent, 'show_main_view'):
            parent.show_main_view()


class MainWindow(QMainWindow):
    """–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏")
        self.setMinimumSize(800, 600)
        self.setup_ui()
        self.load_categories()
        self.apply_styles()
    
    def setup_ui(self):
        # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç
        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)
        
        # –ì–ª–∞–≤–Ω—ã–π layout
        self.main_layout = QVBoxLayout(self.central_widget)
        
        # –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã
        self.create_main_view()
        self.create_category_view()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –≤–∏–¥–∂–µ—Ç
        self.show_main_view()
    
    def create_main_view(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –≤–∏–¥–∞"""
        self.main_widget = QWidget()
        layout = QVBoxLayout(self.main_widget)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = QLabel("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏")
        title_label.setFont(QFont("Arial", 24, QFont.Weight.Bold))
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title_label.setStyleSheet("color: #2c3e50; margin: 20px;")
        
        layout.addWidget(title_label)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        self.stats_widget = QWidget()
        self.stats_widget.setStyleSheet("""
            QWidget {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                margin: 10px;
            }
        """)
        stats_layout = QHBoxLayout(self.stats_widget)
        
        # –î–æ—Ö–æ–¥—ã
        income_layout = QVBoxLayout()
        income_title = QLabel("–û–±—â–∏–π –¥–æ—Ö–æ–¥")
        income_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        income_title.setStyleSheet("color: #666; font-size: 12px;")
        
        self.income_label = QLabel("0.00 ‚ÇΩ")
        self.income_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.income_label.setFont(QFont("Arial", 18, QFont.Weight.Bold))
        self.income_label.setStyleSheet("color: #28a745;")
        
        income_layout.addWidget(income_title)
        income_layout.addWidget(self.income_label)
        
        # –†–∞—Å—Ö–æ–¥—ã
        expense_layout = QVBoxLayout()
        expense_title = QLabel("–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥")
        expense_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        expense_title.setStyleSheet("color: #666; font-size: 12px;")
        
        self.expense_label = QLabel("0.00 ‚ÇΩ")
        self.expense_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.expense_label.setFont(QFont("Arial", 18, QFont.Weight.Bold))
        self.expense_label.setStyleSheet("color: #dc3545;")
        
        expense_layout.addWidget(expense_title)
        expense_layout.addWidget(self.expense_label)
        
        # –ë–∞–ª–∞–Ω—Å
        balance_layout = QVBoxLayout()
        balance_title = QLabel("–ë–∞–ª–∞–Ω—Å")
        balance_title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        balance_title.setStyleSheet("color: #666; font-size: 12px;")
        
        self.balance_label = QLabel("0.00 ‚ÇΩ")
        self.balance_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.balance_label.setFont(QFont("Arial", 18, QFont.Weight.Bold))
        self.balance_label.setStyleSheet("color: #007bff;")
        
        balance_layout.addWidget(balance_title)
        balance_layout.addWidget(self.balance_label)
        
        stats_layout.addLayout(income_layout)
        stats_layout.addLayout(expense_layout)
        stats_layout.addLayout(balance_layout)
        
        layout.addWidget(self.stats_widget)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        button_layout = QHBoxLayout()
        
        self.add_category_button = QPushButton("+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é")
        self.add_category_button.clicked.connect(self.add_category)
        
        self.delete_category_button = QPushButton("üóë –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é")
        self.delete_category_button.clicked.connect(self.delete_category)
        
        button_layout.addWidget(self.add_category_button)
        button_layout.addWidget(self.delete_category_button)
        button_layout.addStretch()
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        self.search_button = QPushButton("üîç –ü–æ–∏—Å–∫")
        self.search_button.clicked.connect(self.show_search)
        
        self.reports_button = QPushButton("üìä –û—Ç—á–µ—Ç—ã")
        self.reports_button.clicked.connect(self.show_reports)
        
        self.export_button = QPushButton("üì§ –≠–∫—Å–ø–æ—Ä—Ç")
        self.export_button.clicked.connect(self.show_export)
        
        self.budget_button = QPushButton("üí∞ –ë—é–¥–∂–µ—Ç")
        self.budget_button.clicked.connect(self.show_budget)
        
        button_layout.addWidget(self.search_button)
        button_layout.addWidget(self.reports_button)
        button_layout.addWidget(self.export_button)
        button_layout.addWidget(self.budget_button)
        
        layout.addLayout(button_layout)
        
        # –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        self.categories_list = QListWidget()
        self.categories_list.itemDoubleClicked.connect(self.open_category)
        layout.addWidget(self.categories_list)
        
        self.main_layout.addWidget(self.main_widget)
    
    def create_category_view(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        self.category_widget = None  # –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    
    def apply_styles(self):
        """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π"""
        self.setStyleSheet("""
            QMainWindow {
                background: #f8f9fa;
            }
            QPushButton {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                font-size: 14px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #0056b3;
            }
            QPushButton:pressed {
                background: #004085;
            }
            QListWidget {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
            }
            QListWidget::item {
                background: transparent;
                border: none;
                padding: 5px;
            }
            QListWidget::item:selected {
                background: #e3f2fd;
                border-radius: 5px;
            }
        """)
    
    def load_categories(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î"""
        self.categories_list.clear()
        categories = get_all_category()
        
        for category_id, category_name in categories:
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            category_stats = self.get_category_statistics(category_id)
            
            # –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            category_widget = QWidget()
            category_layout = QHBoxLayout(category_widget)
            category_layout.setContentsMargins(15, 10, 15, 10)
            category_widget.setMinimumHeight(48)
            
            # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            name_label = QLabel(category_name)
            name_label.setFont(QFont("Arial", 16, QFont.Weight.Bold))
            name_label.setStyleSheet("color: #2c3e50;")
            name_label.setWordWrap(True)
            name_label.setMinimumHeight(32)
            name_label.setMaximumHeight(48)
            name_label.setAlignment(Qt.AlignmentFlag.AlignVCenter | Qt.AlignmentFlag.AlignLeft)
            name_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)
            
            category_layout.addWidget(name_label)
            category_layout.addStretch()
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if category_stats['income'] > 0:
                income_label = QLabel(f"+{category_stats['income']:.0f} ‚ÇΩ")
                income_label.setStyleSheet("color: #28a745; font-weight: bold; font-size: 14px;")
                category_layout.addWidget(income_label)
            if category_stats['expense'] > 0:
                expense_label = QLabel(f"-{category_stats['expense']:.0f} ‚ÇΩ")
                expense_label.setStyleSheet("color: #dc3545; font-weight: bold; font-size: 14px;")
                category_layout.addWidget(expense_label)
            
            # –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
            item = QListWidgetItem()
            item.setData(Qt.ItemDataRole.UserRole, category_id)
            item.setData(Qt.ItemDataRole.DisplayRole, category_name)
            item.setSizeHint(category_widget.sizeHint())
            self.categories_list.addItem(item)
            self.categories_list.setItemWidget(item, category_widget)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self.update_statistics()
    
    def get_category_statistics(self, category_id):
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        try:
            stats = get_category_statistics(category_id)
            return stats
        except:
            return {'income': 0, 'expense': 0}
    
    def update_statistics(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        stats = get_total_statistics()
        
        self.income_label.setText(f"{stats['income']:.2f} ‚ÇΩ")
        self.expense_label.setText(f"{stats['expense']:.2f} ‚ÇΩ")
        self.balance_label.setText(f"{stats['balance']:.2f} ‚ÇΩ")
        
        # –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
        if stats['balance'] > 0:
            self.balance_label.setStyleSheet("color: #28a745;")
        elif stats['balance'] < 0:
            self.balance_label.setStyleSheet("color: #dc3545;")
        else:
            self.balance_label.setStyleSheet("color: #007bff;")
    
    def add_category(self):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        dialog = CategoryDialog(self)
        if dialog.exec() == QDialog.DialogCode.Accepted:
            name = dialog.name_edit.text().strip()
            if name:
                add_category(name)
                self.load_categories()
            else:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
    
    def delete_category(self):
        """–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        current_item = self.categories_list.currentItem()
        if not current_item:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!")
            return
        
        # –ò–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë–º –∏–∑ item.data(Qt.DisplayRole)
        category_name = current_item.data(Qt.ItemDataRole.DisplayRole)
        if not category_name:
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!")
            return
        reply = QMessageBox.question(
            self, 
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
            f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é '{category_name}' –∏ –≤—Å–µ –µ—ë –ø–ª–∞—Ç–µ–∂–∏?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        if reply == QMessageBox.StandardButton.Yes:
            del_category(category_name)
            self.load_categories()
    
    def open_category(self, item):
        """–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π"""
        category_id = item.data(Qt.ItemDataRole.UserRole)
        category_name = item.text()
        
        # –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        self.category_widget = CategoryViewWidget(category_id, category_name, self)
        self.main_layout.addWidget(self.category_widget)
        
        # –°–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –≤–∏–¥
        self.main_widget.hide()
        self.category_widget.show()
    
    def show_main_view(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –≤–∏–¥"""
        if self.category_widget:
            self.category_widget.hide()
            self.main_layout.removeWidget(self.category_widget)
            self.category_widget.deleteLater()
            self.category_widget = None
        
        self.main_widget.show()
    
    def show_search(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –ø–æ–∏—Å–∫–∞"""
        dialog = SearchDialog(self)
        dialog.exec()
    
    def show_reports(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –æ—Ç—á–µ—Ç–æ–≤"""
        dialog = ReportsDialog(self)
        dialog.exec()
    
    def show_export(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        dialog = ExportDialog(self)
        dialog.exec()
    
    def show_budget(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –±—é–¥–∂–µ—Ç–∞"""
        dialog = BudgetDialog(self)
        dialog.exec()


def main():
    app = QApplication(sys.argv)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app.setStyle('Fusion')
    
    # –°–æ–∑–¥–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
    window = MainWindow()
    window.show()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    sys.exit(app.exec())


if __name__ == "__main__":
    main() 